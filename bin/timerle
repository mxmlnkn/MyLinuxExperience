#!/bin/bash

quiet=0
message=""
waitTime='0'
args=()
while [ -n "$1" ]; do
    case "$1" in
        -q|--quiet)
            quiet=1
            ;;
        -m|--message)
            shift
            message="$1"
            ;;
        *)
            # specified is a date not a wait duration
            if [[ "$1" =~ ^[0-2]?[0-9]:[0-6]?[0-9]$ ]]; then
                dh=$(( ${1%:*} - $(date +%H) ))
                if [ "$dh" -lt 0 ]; then
                    dh=$((dh + 24))
                fi
                dm=$(( ${1#*:} - $(date +%M) ))
                if [ "$dm" -lt 0 ]; then
                    dm=$((dm + 60))
                    dh=$((dh - 1 ))
                fi
                waitTime=( "$(( dh * 60 + dm ))m" )
                continue
            elif [[ "$1" =~ ^[0-9]*[hms]*$ ]]; then
                waitTime="$1"
            fi
            ;;
    esac
    shift
done

echo "Timerle startet on $(date '+%Y-%m-%d %H-%M-%S') will will finish in ${waitTime}"
sleep "$waitTime"
if [ "$quiet" -eq 0 ]; then
    ffplay -loop 0 -nodisp "$HOME/.config/alarm.wav" &> /dev/null &
    pid=$!
    #echo "PID (ffplay) = $pid"
fi
xview "$HOME/.config/timerle.png" &>/dev/null &&
if [ "$quiet" -eq 0 ]; then
    kill $pid
fi

if [ -n "$message" ]; then
    notify-send 'Timerle' "$message"
fi
